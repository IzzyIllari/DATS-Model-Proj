---
title: "Olympics_EDA"
author: "LNT"
date: "03/12/2020"
output:
 rmdformats::readthedown:
    highlight: kate
    code_folding: hide
---


```{r basic, include=F}
# use this function to conveniently load libraries and work smoothly with knitting
# can add quietly=T option to the require() function
loadPkg = function(pkg, character.only = FALSE) { 
  if (!character.only) { pkg <- as.character(substitute(pkg)) }
  pkg <- ifelse(!character.only, as.character(substitute(pkg)) , pkg)  
  if (!require(pkg,character.only=T, quietly =T)) {  install.packages(substitute(pkg),dep=T); if(!require(pkg,character.only=T)) stop("Package not found") } 
}
loadPkg(knitr)

# unload/detact package when done using it
unloadPkg = function(pkg, character.only = FALSE) { 
  if(!character.only) { pkg <- as.character(substitute(pkg)) } 
  search_item <- paste("package", pkg,sep = ":") 
  while(search_item %in% search()) { detach(search_item, unload = TRUE, character.only = TRUE) } 
}
```

```{r setup, echo=FALSE, cache=FALSE}


## Global options
options(max.print="75")
knitr::opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
knitr::opts_knit$set(width=75)
options(scientific=T, digits = 3) 
```

```{r xkablesummary}
loadPkg("xtable")
loadPkg("kableExtra")
loadPkg("stringi")

xkabledply = function(smmry, title='Caption', pos='left') { # Thanks Ryan Longmuir for the codes
  smmry %>%
    xtable() %>% 
    kable(caption = title, digits = 4) %>%
    kable_styling(position = "center") %>%
    kable_styling(bootstrap_options = "striped", full_width = F,
    position = pos)
}

xkablesummary = function(df) { 
  #' Combining base::summary, xtable, and kableExtra, to easily display numeric variable summary of dataframes. 
  #` If the categorical variables has less than 6 levels, the function will still run without error.
  #' ELo 202003 GWU DATS
  #' version 1
  #' @param df The dataframe.
  #' @return The summary table for display, or for knitr to process into other formats 
  #' @examples
  #' xkablesummary( faraway::ozone )
  #' xkablesummary( ISLR::Hitters )
  
  s = summary(df) %>%
    apply( 2, function(x) stringr::str_remove_all(x,c("Min.\\s*:\\s*","1st Qu.\\s*:\\s*","Median\\s*:\\s*","Mean\\s*:\\s*","3rd Qu.\\s*:\\s*","Max.\\s*:\\s*")) ) %>% # replace all leading words
    apply( 2, function(x) stringr::str_trim(x, "right")) # trim trailing spaces left
  
  colnames(s) <- stringr::str_trim(colnames(s))
  
  if ( dim(s)[1] ==6 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max') 
  } else if ( dim(s)[1] ==7 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max','NA') }
  
  s %>%
    xkabledply("Table: Statistics summary.", "center")

}

xkablevif = function(model) { 
  #' Combining faraway::vif, xtable, and kableExtra, to easily display numeric summary of VIFs for a model. 
  #' ELo 202003 GWU DATS
  #' version 1
  #' @param df The dataframe.
  #' @return The summary table for display, or for knitr to process into other formats 
  #' @examples
  #' xkablevif( model )
  
  vifs = table( names(model$coefficients)[2:length(model$coefficients)] ) # remove intercept to set column names
  vifs[] = faraway::vif(model) # set the values

  vifs %>%
    xtable() %>% 
    kable(caption = "VIFs of the model", digits = 4, col.names = 'VIF') %>% # otherwise it will only has the generic name as 'V1' for the first vector in the table
    kable_styling(position = "center") %>%
    kable_styling(bootstrap_options = "striped", full_width = F,
    position = "left")
}
```

```{r loadpackages}
loadPkg("digest")
loadPkg("corrplot")
loadPkg("ggcorrplot")
loadPkg("dplyr")
loadPkg("ggplot2")
loadPkg("rmdformats")
loadPkg("knitr")
loadPkg("lattice") 
loadPkg("jtools")
loadPkg("faraway")
loadPkg("leaps")
loadPkg("gridExtra")
loadPkg("dplyr")
```

```{r read_data}
# Load data
# 
olympics <- read.csv("olympic_data.csv") 
olympics <- na.omit(olympics)
```


```{r structure}
str(olympics)


```

```{r keep, results = "markup"}

olympics$Sex.Int <- c(as.numeric(as.factor(olympics$Sex)))
olympics$NOC.Int <- c(as.numeric(as.factor(olympics$NOC)))
olympics$Sport.Int <- c(as.numeric(as.factor(olympics$Sport)))

```


#Olympics Correlation plot
```{r}
loadPkg("GGally")
ggcorr(olympics, label= TRUE, label_alpha = TRUE)
unloadPkg("GGally")
```

```{r}

olympics_df <- olympics %>% select(Sport.Int,NOC.Int, Sex.Int, Medal.No.Yes, GDPpC, GDP, Population,BMI.Category, BMI, Weight, Height, Age, Year)

olympics_cor <- cor(olympics_df,use="complete.obs")

corrplot.mixed(olympics_cor)


```

```{r lattice}

#pairs(olympics_cor)
```

# Olympics 1915-1925.  First World War (1914-18) and 1918 (H1N1) Pandemic (aka Spanish Flu)
[https://www.ncbi.nlm.nih.gov/books/NBK22148/] (https://www.ncbi.nlm.nih.gov/books/NBK22148/)
The following countries in Europe had 2.64 million excess deaths occurred during the period when the H1N1 Pandemic (Spanish Flu) was circulating from January 1918 - June 1919: Italy, Bulgaria, Portugal, Spain, Netherlands, Sweden, Germany, Switzerland, France, Norway, Denmark, UK (Scotland, England, Wales). In the US, 675,000 people died from H1N1 which nearly was 0.8 percent of the 1910 population. 


```{r read_pandemic_data}

p_olympics <- read.csv("pandemic_olympics.csv")


```
(JOHNSON, NIALL P. A. S., and JUERGEN MUELLER. “Updating the Accounts: Global Mortality of the 1918-1920 ‘Spanish’ Influenza Pandemic.” Bulletin of the History of Medicine, vol. 76, no. 1, 2002, pp. 105–115. JSTOR, www.jstor.org/stable/44446153. Accessed 19 Apr. 2020.)

```{r H1N1_pandemic}

NOC_SF <- c("ITA", "BUL", "POR", "ESP", "NED", "SWE", "FRG", "GDR", "GER", "SAA", "SUI", "FRA", "NOR", "DEN", "GBR", "USA")
Medals <- c("Gold", "Silver", "Bronze")

pandemic_NOC_Yr_Mdl <- p_olympics %>% filter(Year >= 1908 & Year <= 1924,
                                         NOC %in% NOC_SF,
                                         Medal %in% Medals) %>% group_by(NOC, Year) %>% tally()

pandemic_NOC_Yr_Mdl$Year <- as.factor(pandemic_NOC_Yr_Mdl$Year)
```


```{r plots_num_medals , include=TRUE}



pandemic_df <- data.frame(pandemic_NOC_Yr_Mdl$NOC, pandemic_NOC_Yr_Mdl$Year, pandemic_NOC_Yr_Mdl$n)
pandemic_df <- unique(pandemic_df)
colnames(pandemic_df) <- c("NOC", "Year", "Total.Medals")

pandemic_df$NOC <- as.factor(pandemic_df$NOC)



# Basic line plot with points
ggplot(data=pandemic_df, aes(x=Year, y=Total.Medals, group=NOC, color=NOC)) +
  geom_line()+
   geom_vline(xintercept = 1918) +
  geom_point()+
 theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 9, hjust = 1),
        axis.text.y = element_text(vjust = 1, size = 9),
        panel.border = element_rect(color = "black", fill=NA, size=1)) +
  labs(title="H1N1 Pademic: Num of medals (n) vs. Year (1908-1924)", x="Year", y="Number of medals (n)")


```

```{r plots_num_athletes , include=TRUE}

pandemic_num_athletes <- p_olympics %>% filter(Year >= 1908 & Year <= 1924,
                                         NOC %in% NOC_SF) %>% group_by(NOC, Year) %>% tally()


pandemic_athletes_df <- data.frame(pandemic_num_athletes$NOC, pandemic_num_athletes$Year, pandemic_num_athletes$n)
pandemic_athletes_df <- unique(pandemic_athletes_df)
colnames(pandemic_athletes_df) <- c("NOC", "Year", "Total.Athletes")
pandemic_athletes_df$NOC <- as.factor(pandemic_athletes_df$NOC)
pandemic_athletes_df$Year <- as.factor(pandemic_athletes_df$Year)
pandemic_athletes_df$V_line <- c("1918") 


# Basic line plot with points
ggplot(data=pandemic_athletes_df, aes(x=Year, y=Total.Athletes, group=NOC, color=NOC)) +
  geom_line()+
   geom_vline(xintercept = 1918) +
  geom_point()+
 theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 9, hjust = 1),
        axis.text.y = element_text(vjust = 1, size = 9),
        panel.border = element_rect(color = "black", fill=NA, size=1)) +
  labs(title="H1N1 Pademic: Num of Athletes (n) vs. Year (1908-1924)", x="Year", y="Number of Athletes (n)")
  

```


```{r ageSF}
loadPkg(dplyr)
pandemic_avg_age <- p_olympics %>% filter(Year >= 1908 & Year <= 1924,
                                         NOC %in% NOC_SF) %>% group_by(NOC, Year) %>% summarise(avg = mean(Age))

pandemic_avg_age$Year <- as.factor(pandemic_avg_age$Year)


# Basic line plot with points
ggplot(data=pandemic_avg_age, aes(x=Year, y=avg, group=NOC, color=NOC)) +
  geom_line()+
   geom_vline(xintercept = 1918) +
  geom_point()+
 theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 9, hjust = 1),
        axis.text.y = element_text(vjust = 1, size = 9),
        panel.border = element_rect(color = "black", fill=NA, size=1)) +
  labs(title="H1N1 Pademic: Average Age vs. Year (1908-1924)", x="Year", y="Number of Athletes (n)")
```


```{r w_h}
pandemic_avg_hw <- p_olympics %>% filter(Year >= 1908 & Year <= 1924,
                                         NOC %in% NOC_SF) %>% group_by(NOC, Year) %>% summarise(avg_h = mean(Height),
              avg_w = mean(Weight))

pandemic_avg_hw$Year <- as.factor(pandemic_avg_hw$Year)


# Basic line plot with points
h1 <- ggplot(data=pandemic_avg_hw, aes(x=Year, y=avg_h, group=NOC, color=NOC)) +
  geom_line()+
   geom_vline(xintercept = 1918) +
  geom_point()+
 theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 9, hjust = 1),
        axis.text.y = element_text(vjust = 1, size = 9),
        panel.border = element_rect(color = "black", fill=NA, size=1)) +
  labs(title="H1N1 Pademic: Average Height vs. Year (1908-1924)", x="Year", y="Avg Height (cm)")

w1 <- ggplot(data=pandemic_avg_hw, aes(x=Year, y=avg_w, group=NOC, color=NOC)) +
  geom_line()+
   geom_vline(xintercept = 1918) +
  geom_point()+
 theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 9, hjust = 1),
        axis.text.y = element_text(vjust = 1, size = 9),
        panel.border = element_rect(color = "black", fill=NA, size=1)) +
  labs(title="H1N1 Pademic: Average Height vs. Year (1908-1924)", x="Year", y="Avg Height (cm)")

grid.arrange(h1,w1)

```



```{r SF_Sport}
#pre_pandemic_sport <- ggplot(pre_pandemic_NOC_Yr_Mdl_sprt, aes(x=reorder(Sport, -n), y=n, color=Sport, fill=Sport)) +
#  geom_bar(aes(y=n), stat="identity") + 
#  theme_minimal() +
#  theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 12, hjust = 1), 
#       axis.text.y = element_text(vjust = 1, size = 12, hjust = 1), 
#       panel.border = element_rect(colour = "black", fill=NA, size=1)) + 
#  labs(title="Pre-Pandemic: Sports by Countries Impacted (1908-1912)", x="Event", y="Number of athletes") 
#pre_pandemic_sport

#post_pandemic_sport <- ggplot(data=oly_SF_NOC_Yr_Mdl_sprt, aes(x=reorder(Sport, -n), y=n, color=Sport, fill=Sport)) +
# geom_bar(aes(y=n), stat="identity") + 
#  theme_minimal() +
#  theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 12, hjust = 1), 
#     axis.text.y = element_text(vjust = 1, size = 12, hjust = 1), 
#       panel.border = element_rect(colour = "black", fill=NA, size=1)) +   labs(title="Post-Pandemic: Sports by Countries Impacted (1920-1924)", x="Event", y="Number of athletes") 
#post_pandemic_sport

#grid.arrange(pre_pandemic_sport,post_pandemic_sport)
```

